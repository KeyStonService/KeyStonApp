name: CD Pipeline

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'

env:
  KUBERNETES_VERSION: '1.28'

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: https://staging.quantumflow.example.com
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBERNETES_VERSION }}
      
      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBECONFIG_STAGING }}" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig
      
      - name: Deploy to Kubernetes
        run: |
          export KUBECONFIG=kubeconfig
          kubectl apply -k deploy/kubernetes/
          kubectl rollout status deployment/quantumflow-backend -n quantumflow
          kubectl rollout status deployment/quantumflow-frontend -n quantumflow

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: production
      url: https://quantumflow.example.com
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBERNETES_VERSION }}
      
      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig
      
      - name: Deploy to Kubernetes
        run: |
          export KUBECONFIG=kubeconfig
          kubectl set image deployment/quantumflow-backend \
            backend=quantumflow/backend:${{ github.ref_name }} \
            -n quantumflow
          kubectl set image deployment/quantumflow-frontend \
            frontend=quantumflow/frontend:${{ github.ref_name }} \
            -n quantumflow
          kubectl rollout status deployment/quantumflow-backend -n quantumflow
          kubectl rollout status deployment/quantumflow-frontend -n quantumflow
      
      - name: Run smoke tests
        run: |
          export KUBECONFIG=kubeconfig
          # Wait for services to be ready
          sleep 30
          # Run smoke tests
          curl -f https://quantumflow.example.com/api/health || exit 1

